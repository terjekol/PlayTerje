<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labyrint</title>
    <style>
        button.command {
            font-size: 150%;
            background-color: green;
            color: white;
        }

        input {
            font-size: 150%;
        }

        button.nonCommand {
            font-size: small;
        }

        pre {
            font-size: 150%;
        }

        .code {
            font-family: monospace;
            font-size: 150%;
        }

        .customCommands {
            display: flex;
            flex-direction: row;
            justify-content: start;
        }

        .customCommand {
            padding: 2vmin;
            margin-right: 2vmin;
            border: 0.5vmin dashed gray;

        }

        .page {
            display: flex;
            flex-direction: row;
            justify-content: start;
        }
    </style>
</head>

<body>
    <div class="page">
        <div><canvas id="myCanvas"></canvas></div>
        <div id="panel"></div>
    </div>
    <script src="labyrinth.js"></script>
    <script>
        localInit();

        function localInit() {
            init(3);
            const model = globals.model;
            model.customCommands = [
                {
                    name: 'Snu venstre',
                    codeName: 'snuVenstre',
                    commands: [
                        {
                            type: 'call',
                            command: 'snuHøyre',
                        },
                        {
                            type: 'call',
                            command: 'snuHøyre',
                        },
                        {
                            type: 'call',
                            command: 'snuHøyre',
                        },
                    ],
                },
            ];
            updateView();
        }

        function run(code) {
            const model = globals.model;
            model.lastCommand = { code };
            model.lastCommand.returnValue = quotify(eval(code));
            updateView();
        }

        function quotify(value) {
            return typeof (value) === 'string' ? `'${value}'` : value;
        }

        function updateView() {
            const model = globals.model;
            document.getElementById('panel').innerHTML = `
                <h1>Innebygde kommandoer</h1>
                <button class="command" onclick="run('gå()')">Gå</button>
                <button class="command" onclick="run('snuHøyre()')">Snu høyre</button>
                <button class="command" onclick="run('erVedUtgang()')">Er ved utgang?</button>
                <br/>
                ${createLastCodeHtml(
                model.lastCommand ? model.lastCommand.code : '',
                model.lastCommand ? model.lastCommand.returnValue : '')}
                <h1>Egne kommandoer</h1>
                <div class="customCommands">
                    ${model.customCommands.map(createCustomCommandHtml).join('')}
                    <div class="customCommand" style="align-self: stretch">
                        <div style="display: flex; align-items: center; height: 100%">
                            <button class="nonCommand">+</button>
                        </div>
                    </div>
                </div>
            `;
            if (model.requestFocus) {
                const inputTag = document.getElementById(model.requestFocus.name);
                inputTag.focus();
                inputTag.setSelectionRange(model.requestFocus.selectionStart, model.requestFocus.selectionEnd);
                model.requestFocus = null;
            }
        }

        function createCustomCommandHtml(customCommand, index) {
            const isInEditMode = globals.model.customCommands[index].isInEditMode;
            const preHtml = isInEditMode ? `
                <input id="commandName" type="text" value="${customCommand.name}" oninput="editCommandName(this, ${index})"/><br/>
            `: `
                <button 
                    class="command" 
                    onclick="runCustomCommand('${customCommand.name}')"
                    >
                    ${customCommand.name}
                </button>            
            `;
            const postHtml = isInEditMode ? `
                <button onclick="editCustomCommand(${index}, false)">Avslutt redigering</button>
                `: `
                <button onclick="editCustomCommand(${index}, true)">Rediger</button>
                <button onclick="deleteCustomCommand(${index})">Slett</button>
                `;

            return `
                <div class="customCommand">
                    ${preHtml}                    
                    <pre>${createJavaScriptFunction(customCommand)}</pre>
                    ${postHtml}
                </div>
                `;
        }

        function createJavaScriptFunction(customCommand) {
            return `function ${customCommand.codeName}() {\n`
                + customCommand.commands.map(
                    codeCommand => `  ${codeCommand.command}()\n`)
                    .join('')
                + '}\n';
        }

        function createLastCodeHtml(command, returnValue) {
            return `<div class="code">
                        <span style="color: gray">Kommando: &nbsp;</span>
                        ${command}
                        <br/>
                        <span style="color: gray">Returverdi: </span>${returnValue}
                    </div>
                `;
        }

        // controller
        function editCustomCommand(index, isInEditMode) {
            globals.model.customCommands[index].isInEditMode = isInEditMode;
            updateView();
        }

        function deleteCustomCommand(index) {
            globals.model.customCommands.splice(index, 1);
            updateView();
        }

        function editCommandName(inputTag, index) {
            const customCommand = globals.model.customCommands[index];
            customCommand.name = inputTag.value;
            customCommand.codeName = toCamelCase(inputTag.value);
            globals.model.requestFocus = {
                name: inputTag.id,
                selectionStart: inputTag.selectionStart,
                selectionEnd: inputTag.selectionEnd,
            };
            updateView();
        }

        function toCamelCase(str) {
            return str.split(' ').map(function (word, index) {
                return index == 0 ? word.toLowerCase() :  word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join('');
        }
    </script>
</body>

</html>